#!/usr/bin/ruby
require 'yaml'
require 'digest/md5'

class Conf
  CONFIG = YAML::load open(File.expand_path 'config.yml', File.dirname(__FILE__)).read

  def self.method_missing(name, *args)
    CONFIG[name.to_s]
  end
end

def system_run(cmd)
  puts cmd
  system cmd
end

def upload(fname)
  return unless File.exists? fname

  ext = fname.split(/\//).last =~ /^(.*)(\.\w+)$/ ? $2 : ''
  hash = Digest::MD5.hexdigest open(fname).read

  system_run "ssh #{Conf.ssh} mkdir -p  #{Conf.dir}"
  system_run "scp '#{fname}' #{Conf.ssh}:#{Conf.dir}#{hash}#{ext}"
  system_run "ssh #{Conf.ssh} chmod 644 #{Conf.dir}#{hash}#{ext}"

  furl = "#{Conf.url}#{hash}#{ext}"
  puts " => #{furl}"
  system_run "echo '#{furl}' | pbcopy"
  system_run "open '#{furl}'"
end

def capture
  fname_png = "/tmp/face-upload-#{Time.now.to_i}_#{Time.now.usec}.png"
  fname_jpg = "/tmp/face-upload-#{Time.now.to_i}_#{Time.now.usec}.jpg"
  system_run "screencapture -i #{fname_png}"
  return unless File.exists? fname_png
  system_run "sips -d profile --deleteColorManagementProperties '#{fname_png}'"
  system_run "sips -s format jpeg #{fname_png} --out #{fname_jpg}"
  if File.size(fname_png) > File.size(fname_jpg)
    File.delete fname_png
    return fname_jpg
  else
    File.delete fname_jpg
    return fname_png
  end
end

if ARGV.empty?
  fname = capture
  if fname
    upload fname
    File.delete fname
  end
else
  ARGV.each do |fname|
    upload fname
  end
end
