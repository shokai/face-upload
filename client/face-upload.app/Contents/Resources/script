#!/usr/bin/ruby
require 'yaml'
require 'digest/md5'

conf = YAML::load open(File.dirname(__FILE__)+'/config.yml').read
ssh = conf['ssh']
dir = conf['dir']
url = conf['url']

ARGV.each do |fname|
  next unless File.exists? fname

  ext = fname.split(/\//).last =~ /^(.*)(\.\w+)$/ ? $2 : ''
  hash = Digest::MD5.hexdigest open(fname).read

  puts cmd = "scp '#{fname}' #{ssh}:#{dir}#{hash}#{ext}"
  system cmd
  puts cmd = "ssh #{ssh} chmod 644 #{dir}#{hash}#{ext}"
  system cmd

  furl = "#{url}#{hash}#{ext}"
  puts " => #{furl}"
  system "echo '#{furl}' | pbcopy"
  system "open '#{furl}'"
end
